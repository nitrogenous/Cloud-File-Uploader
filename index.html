<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="viewport" content="height=device-height, initial-scale=1.0">
    <script src="jquery-3.2.1.min.js"></script>
    <link rel="stylesheet" href="index.css">
    <link href="https://fonts.googleapis.com/css?family=Roboto+Condensed" rel="stylesheet">
    <script src="//js.jotform.com/JotFormCustomWidget.min.js"></script>
    <script src="https://unpkg.com/dropbox/dist/Dropbox-sdk.min.js"></script>
    <script src="utils.js"></script>
    <title>XUP File Uploader</title>
</head>
<body>
    <!-- <center> --> 
    <form action="database.php" method="POST" enctype="multipart/form-data" id="xup" >
        <!-- <progress value="0" max="100" id="progressbar"></progress> -->
        <label for="upload" id="uploadbutton">Choose a File</label>
        <input type="file" name="upload[]" id="upload" multiple>
        <input type="hidden" id="hidden">
        <input type="hidden" id="key">
        <input type="hidden" id="folder">
        <input type="hidden" id="uploaded">
        <input type="hidden" id="folderKey">
        <input type="hidden" id="url" value="false">
        <div id="qid"> </div>
    </form>
    <div id="text"></div>
    <!-- </center> -->
    <script type="text/javascript">
        JFCustomWidget.subscribe("ready", function (formId) {
            $(document).ready(function(){    
                // var size ={};
                // size.width = ((document.body.offsetWidth/100)*100);
                // size.height = ((document.body.offsetHeight/100)*100);    
                // JFCustomWidget.requestFrameResize(size);
                var formdata = new FormData();
                const form_id = formId["formID"];
                const qid = JFCustomWidget.getWidgetSetting("qid");
                const clouds = JFCustomWidget.getWidgetSetting("clouds");
                var status;
                formdata.append("formid", form_id);
                formdata.append("clouds", clouds); 
                formdata.append("qid",qid);
                formdata.append("action", "check");
                $.ajax({
                    type: "POST",
                    url: "database.php",
                    enctype: "multipart/form-data",
                    data: formdata,
                    async: false,
                    cache: false,
                    contentType: false,
                    processData: false,
                    success: function (sccss) {
                        document.getElementById("hidden").value = sccss;
                    }
                });
                var status = JSON.parse(document.getElementById("hidden").value); 
                console.log(status);
                if((clouds.toLowerCase()).indexOf("amazonwebservices") != -1){
                    var access = JFCustomWidget.getWidgetSetting("awsaccess");
                    var secret = JFCustomWidget.getWidgetSetting("awssecret");
                    var bucket = JFCustomWidget.getWidgetSetting("awsbucket");
                    if(empty(access) || empty(secret) || empty(bucket)){
                        document.getElementById("upload").disable = true;
                        document.getElementById("text").innerHTML = "<h3>Please check your AWS integration!</h3>";
                    }
                    else{
                        document.getElementById("text").innerHTML = "";
                    }
                }
                if((clouds.toLowerCase()).indexOf("dropbox") != -1){ 
                    if(status.Dropbox != true){
                        var client_id = "9pdfdpjr2pnqzmo";
                        var dbx = new Dropbox({clientId: client_id});
                        var authUrl = dbx.getAuthenticationUrl("https://toprak.jotform.pro/Adapter/oauth.html"); 
                        var AuthWindow = window.open(authUrl,"AuthWindow",'location=0,status=0,width=800,height=400');
                        $("#key").change(function(){
                            key = document.getElementById("key").value;
                            var formdata = new FormData();
                            formdata.append("action", "save");
                            formdata.append("qid",qid);
                            formdata.append("value","dropbox");
                            formdata.append("key",key);
                            formdata.append("formid", form_id);
                            formdata.append("clouds", clouds);
                            $.ajax({
                                type: "POST",
                                url: "database.php",
                                enctype: "multipart/form-data",
                                data: formdata,
                                async: false,
                                cache: false,
                                contentType: false,
                                processData: false,
                                success: function (sccss) {
                                    document.getElementById("hidden").value = sccss;
                                }
                            });
                            AuthWindow.close();
                        }) 
                    }
                }
                if((clouds.toLowerCase()).indexOf("drive") !=  -1){
                    if(status.Drive != true){
                        this.onload=function(){};handleClientLoad();
                        var key = "AIzaSyAbodyJck6jBlV4oV9A3-E6xdMvf3JsdDg";
                        var client = "424058548993-sbd0hd1dflne6507emj91gad1pf9bebc.apps.googleusercontent.com";
                        var discovery = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
                        var scopes = "https://www.googleapis.com/auth/drive";
                        function handleClientLoad() {
                            gapi.load("client:auth2",initClient);
                        }
                        function initClient() {
                            gapi.client.init({
                                apiKey: key,
                                clientId: client,
                                discoveryDocs: discovery,
                                scope: scopes
                            }).then(function (){
                            gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);
                            updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
                            handleAuthClick();
                            });
                        }
                        function updateSigninStatus(isSignedIn) {
                            if (isSignedIn) {
                                console.log("signed");
                            }
                             addEventListener
                            {
                                console.log("error");
                            }
                        }
                        function handleAuthClick() {
                            console.log("handleAuthClick");
                            gapi.auth2.getAuthInstance().signIn();
                            gapi.auth2.getAuthInstance().grantOfflineAccess().then(function(code){
                                key = JSON.stringify(code);
                                var formdata = new FormData();
                                formdata.append("qid",qid);
                                formdata.append("value","drive");
                                formdata.append("key",key);
                                formdata.append("formid", form_id);
                                formdata.append("clouds", clouds);
                                formdata.append("action", "tokens");
                                $.ajax({
                                    type: "POST",
                                    url: "database.php",
                                    enctype: "multipart/form-data",
                                    data: formdata,
                                    async: false,
                                    cache: false,
                                    contentType: false,
                                    processData: false,
                                    success: function(sccss){
                                    }
                                });
                            })
                        }
                    }
                }
                $("#upload").change(function(e) {
                    e.preventDefault();
                    newLabelValue("uploadbutton","Add a File");
                    // console.log(document.getElementById("url").value);
                    // // var access_token = document.getElementById("accesskey").value;
                    var key = generate_token(32);
                    var input = document.getElementById("upload");  
                    for(var x = 0;x < input.files.length; x++){
                        var file = input.files[x];
                        upload(form_id,qid,file,key,x);
                    }
                    $("#url").change(function(){  
                        returnSubmit(JSON.stringify(document.getElementById("url").value),true);
                    })
                    // var folder = document.getElementById("folder").value;
                    // removeFiles(form_id,folder);                                   
                });

                JFCustomWidget.subscribe("submit",function(){
                    var folder = document.getElementById("folder").value;
                    if(document.getElementById("url").value != "false"){
                        removeFiles(form_id,folder);                                   
                        returnSubmit(JSON.stringify(document.getElementById("url").value),true);
                    }
                    else{
                        returnSubmit(null,false);
                    }
                })

            })  
        })
        function empty(input) {
            if(input == "" || input == 0 || input == "0" || input == null || input == false || input == undefined)  {
                return true;
            }
            else {
                return false;
            }
        }
        function upload(formid,qid,file,key,progressName){
            var formdata = new FormData();
            var folder = null;
            formdata.append("key",key);
            formdata.append("formid",formid);
            formdata.append("qid",qid);
            formdata.append("file", file); 
            var progressId = createProgress(generate_token(4)); 
            save(formdata,key,progressId).done(function(result){
                document.getElementById("folder").value = result; 
                folder = JSON.parse(document.getElementById("folder").value);
                document.getElementById("folder").value = folder["folder"];
                let qid = JFCustomWidget.getWidgetSetting("qid");
                let clouds = JFCustomWidget.getWidgetSetting("clouds");
                folder = document.getElementById("folder").value;
                var folderKey = document.getElementById("folderKey").value;
                document.getElementById("url").value =  urlReplace(JSON.stringify(sendJob(qid,file.name,clouds,formid,folder,folderKey)));
                $("#url").trigger("change");
            }).fail(function(){
                console.log("An Error Occured");
            });
            return true;
        }
        function save(formdata,key,progressId){
        return $.ajax({
                type: "POST",
                url: "save.php",
                enctype: "multipart/form-data",
                data: formdata,
                cache: false,
                // async: false,
                contentType: false,
                processData: false,
                xhr: function () {
                    var xhr = $.ajaxSettings.xhr();
                    if (xhr.upload) {   
                        xhr.upload.addEventListener("progress", function (e) {
                            var percent = 0;
                            var position = e.loaded || e.position;
                            var total = e.total;
                            if (e.lengthComputable) {
                                percent = Math.ceil(position / total * 100);
                            }
                            $("#"+progressId).attr("value", percent);
                        }, true);
                    }
                    return xhr;
                },
                success: function (sccss) { 
                    // document.getElementById("folder").value = sccss; 
                    // let folder = JSON.parse(document.getElementById("folder").value);
                    // document.getElementById("folder").value = folder["folder"];
                    // console.log(document.getElementById("folder").value);
                    // let qid = JFCustomWidget.getWidgetSetting("qid");
                    // let file = document.getElementById("upload").value.split(/(\\|\/)/g).pop();
                    // let clouds = JFCustomWidget.getWidgetSetting("clouds");
                    // let folder = document.getElementById("folder").value;
                    // var url = sendJob(qid,file,clouds,form_id,folder);
                    // console.log(url);    
                // }
                }
            });
     
        }   
        function removeFiles(form_id,folder){
            console.log("test");
            $.ajax({
                type: "POST",
                url: "removeFiles.php",
                enctype: "multipart/form-data",
                data: {formid: form_id,folder: folder},
                async: false,
                cache: false,
                success: function(sccss){
                    // console.log(sccss);
                }                                    
            })
        }
        function sendJob(qid,file,clouds,formid,folder,folderKey){
            var formdata = new FormData();
            var response = null;
            $key = getAwsKeys();
            formdata.append("qid",qid);
            formdata.append("file",file);
            formdata.append("clouds",clouds);
            formdata.append("formid",formid);
            formdata.append("folder",folder);
            formdata.append("action","upload");
            formdata.append("key",key);
            formdata.append("folderKey",folderKey);
            $.ajax({
                type: "POST",
                url: "database.php",
                enctype: "multipart/form-data",
                data: formdata,
                async: false,
                cache: false,
                contentType: false,
                processData: false,
                success: function(sccss){
                    callback = JSON.parse(JSON.stringify(JSON.parse(sccss)));
                    google = callback.Drive;
                    google = JSON.parse(JSON.stringify(JSON.parse(google)));
                    document.getElementById("folderKey").value = google.folderKey;
                    googleUrl = urlReplace(google.url);
                    dropboxUrl = urlReplace(callback.Dropbox);
                    url = {Drive: googleUrl,Dropbox: dropboxUrl};
                    document.getElementById("uploaded").value = url;
                    // console.log(url);
                    response = url;
                }
            })   
            return response;
        }
        function getAwsKeys(){
            var access = JFCustomWidget.getWidgetSetting("awsaccess");
            var secret = JFCustomWidget.getWidgetSetting("awssecret");
            var bucket = JFCustomWidget.getWidgetSetting("awsbucket");
            var region = JFCustomWidget.getWidgetSetting("awsregion");
            var key =JSON.stringify({access: access,secret: secret, bucket: bucket,region: region});
            return key;
        }
        function urlReplace(url){
            do{
                old = url;
                url = url.replace("\\","");
                url = url.replace("{","");
                url = url.replace("}","");
                url = url.replace(",","<br>");
                url = url.replace(" ","%20"); //Space = %20
            }
            while(old != url);
            return url;
        }
        function generate_token(length){
            var a = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890".split("");
            var b = [];  
            for (var i=0; i<length; i++) {
                var j = (Math.random() * (a.length-1)).toFixed(0);
                b[i] = a[j];
            }
            return b.join("");
        }
        function returnSubmit(value,valid){
            var result = {};
            result.value = value;
            result.valid = valid;
            JFCustomWidget.sendSubmit(result);
        }
        function createProgress(id){
                var bar = document.createElement("PROGRESS");
                bar.value = 0;
                bar.max = 100;
                bar.id = "progressbar_"+id;
                document.getElementById("xup").appendChild(bar);
                return bar.id;
        }
        function newLabelValue(id,newValue){
            document.getElementById(id).innerHTML = newValue;
            return true;
        }
    </script>
    <script async defer src="https://apis.google.com/js/api.js">
    </script>
</body>
</html> 