<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <!-- <meta name="viewport" content="width=device-width, initial-scale=1.0"> -->
    <!-- <meta name="viewport" content="height=device-height, initial-scale=1.0"> -->
    <script src="jquery-3.2.1.min.js"></script>
    <script src="//js.jotform.com/JotFormCustomWidget.min.js"></script>
    <script src="https://unpkg.com/dropbox/dist/Dropbox-sdk.min.js"></script>
    <script src="utils.js"></script>
    <title>XUP File Uploader</title>
</head>
<body>
    <center>
    <form action="database.php" method="POST" enctype="multipart/form-data" id="xup" >
        <progress value="0" max="100" id="progressbar"></progress>
        <input type="file" name="upload" id="upload">
        <input type="hidden" id="hidden" value="">
        <h3> <input type="hidden" name="key" id="key" value="" > </3>
        <input type="hidden" id="folder">
        <input type="hidden" id="uploaded">
        <!-- <input type="hidden" name="check" id="check"> -->
    <div id="qid"> </div>
    </form>
    <div id="text"></div>
    </center>
    <script type="text/javascript">
        // disable("");
        JFCustomWidget.subscribe("ready", function (formId) {
            $(document).ready(function(){
                console.log(JFCustomWidget.getWidgetSetting("clouds"));
                
                // var size ={};
                // size.width = ((document.body.offsetWidth/100)*50);
                // size.height = ((document.body.offsetHeight/100)*75);
                // JFCustomWidget.requestFrameResize(size);
                var status;
                var formdata = new FormData();
                var qid = JFCustomWidget.getWidgetSetting("qid");
                var clouds = JFCustomWidget.getWidgetSetting("clouds");
                var form_id = formId["formID"];
                formdata.append("formid", form_id);
                formdata.append("clouds", clouds); 
                formdata.append("qid",qid);
                formdata.append("action", "check");
                $.ajax({
                    type: "POST",
                    url: "database.php",
                    enctype: "multipart/form-data",
                    data: formdata,
                    async: false,
                    cache: false,
                    contentType: false,
                    processData: false,
                    success: function (sccss) {
                        document.getElementById("hidden").value = sccss;
                    }
                });
                var status = JSON.parse(document.getElementById("hidden").value); 
                console.log(status);
                if((clouds.toLowerCase()).indexOf("amazonwebservices") != -1)
                {
                    var access = JFCustomWidget.getWidgetSetting("awsaccess");
                    var secret = JFCustomWidget.getWidgetSetting("awssecret");
                    var bucket = JFCustomWidget.getWidgetSetting("awsbucket");
                    if(empty(access) || empty(secret) || empty(bucket)){
                        document.getElementById("upload").disable = true;
                        document.getElementById("text").innerHTML = "<h3>Please check your AWS integration!</h3>";
                    }
                    else{
                        document.getElementById("text").innerHTML = "";
                    }
                }


                if((clouds.toLowerCase()).indexOf("dropbox") != -1)
                { 
                    if(status.Dropbox != true){
                        var client_id = "9pdfdpjr2pnqzmo";
                        var dbx = new Dropbox({clientId: client_id});
                        var authUrl = dbx.getAuthenticationUrl("https://toprak.jotform.pro/Adapter/oauth.html"); 
                        var AuthWindow = window.open(authUrl,"AuthWindow",'location=0,status=0,width=800,height=400');
                        $("#key").change(function(){
                            key = document.getElementById("key").value;
                            var formdata = new FormData();
                            var form_id = formId["formID"];
                            formdata.append("action", "save");
                            formdata.append("qid",qid);
                            formdata.append("value","dropbox");
                            formdata.append("key",key);
                            formdata.append("formid", form_id);
                            formdata.append("clouds", clouds);
                            $.ajax({
                                type: "POST",
                                url: "database.php",
                                enctype: "multipart/form-data",
                                data: formdata,
                                async: false,
                                cache: false,
                                contentType: false,
                                processData: false,
                                success: function (sccss) {
                                    document.getElementById("hidden").value = sccss;
                                    // enable("dropbox");
                                }
                            });
                            AuthWindow.close();
                        }) 
                    }
                    else{
                        // enable("dropbox");
                    }
                }
                if((clouds.toLowerCase()).indexOf("drive") !=  -1)
                {
                    if(status.Drive != true)
                    {
                        this.onload=function(){};handleClientLoad();
                        var key = "AIzaSyAbodyJck6jBlV4oV9A3-E6xdMvf3JsdDg";
                        var client = "424058548993-sbd0hd1dflne6507emj91gad1pf9bebc.apps.googleusercontent.com";
                        var discovery = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
                        var scopes = "https://www.googleapis.com/auth/drive";

                        function handleClientLoad() {
                            gapi.load("client:auth2",initClient);
                        }
                        function initClient() {
                            gapi.client.init({
                                apiKey: key,
                                clientId: client,
                                discoveryDocs: discovery,
                                scope: scopes
                            }).then(function (){
                                gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);
                                updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
                                handleAuthClick();
                            });

                        }
                        function updateSigninStatus(isSignedIn) {
                            if (isSignedIn) {
                                // enable("drive");
                                console.log("signed");
                            }
                            addEventListener
                            {
                                console.log("error");
                            }
                        }
                        function handleAuthClick() {
                            console.log("handleAuthClick");
                            gapi.auth2.getAuthInstance().signIn();
                            gapi.auth2.getAuthInstance().grantOfflineAccess().then(function(code){
                                key = JSON.stringify(code);
                                var formdata = new FormData();
                                var form_id = formId["formID"];
                                formdata.append("qid",qid);
                                formdata.append("value","drive");
                                formdata.append("key",key);
                                formdata.append("formid", form_id);
                                formdata.append("clouds", clouds);
                                formdata.append("action", "tokens");
                                $.ajax({
                                    type: "POST",
                                    url: "database.php",
                                    enctype: "multipart/form-data",
                                    data: formdata,
                                    async: false,
                                    cache: false,
                                    contentType: false,
                                    processData: false,
                                    success: function(sccss){
                                        // enable("drive");
                                    }
                                });
                            })
                        }    
                    }
                    else {
                        // enable("drive");
                    }
                }
                 $("#upload").change(function (e) {
                    e.preventDefault();
                    var formdata = new FormData();
                    var file = document.getElementById("upload").files[0];
                    var access_token = document.getElementById("accesskey");
                    formdata.append("qid",qid);
                    formdata.append("file", file);
                    formdata.append("formid",form_id);
                    $.ajax({
                        type: "POST",
                        url: "save.php",
                        enctype: "multipart/form-data",
                        data: formdata,
                        cache: false,
                        // async: false,
                        contentType: false,
                        processData: false,
                        xhr: function () {
                            var xhr = $.ajaxSettings.xhr();
                            if (xhr.upload) {   
                                xhr.upload.addEventListener("progress", function (e) {
                                    var percent = 0;
                                    var position = e.loaded || e.position;
                                    var total = e.total;
                                    if (e.lengthComputable) {
                                        percent = Math.ceil(position / total * 100);
                                    }
                                    $("#progressbar").attr("value", percent);
                                }, true);
                            }
                            return xhr;
                        },
                        success: function (sccss) {     
                            document.getElementById("folder").value = sccss; 
                            var folder = JSON.parse(document.getElementById("folder").value);
                            document.getElementById("folder").value = folder["folder"];
                            console.log(document.getElementById("folder").value);
                            var qid = JFCustomWidget.getWidgetSetting("qid");
                            var file = document.getElementById("upload").value.split(/(\\|\/)/g).pop();
                            var clouds = JFCustomWidget.getWidgetSetting("clouds");
                            var folder = document.getElementById("folder").value;
                            return sendJob(qid,file,clouds,form_id,folder);
                        }
                    });
                    
                });
                })  
        })
        JFCustomWidget.subscribe("submit", function (formId) { 
            do{
                if(document.getElementById("uploaded").value != true){
                    // alert("Please select a file. If you select a file please wait it's uploading!");
                    console.log("a");
                 }
             }
              while(document.getElementById("uploaded").value == true);
        }); 
        function empty(input) {
            if(input == "" || input == 0 || input == "0" || input == null || input == false || input == undefined)  {
                return true;
            }
            else {
                return false;
            }
        }
        // function enable(cloud){
        //     document.getElementById("check").value = document.getElementById("check").value + "-" + cloud;
        //     console.log(document.getElementById("check").value + " BBBBBB");
        //     check();
        // }
        // function check(){
        //     var clouds = JFCustomWidget.getWidgetSetting("clouds");
        //     clouds = clouds.split(",");
        //     clouds = clouds.filter(function(n){return n != ""});
        //     var cloud = document.getElementById("check").value;
        //     cloud = cloud.split("-");
        //     cloud = cloud.filter(function(n){return n != ""});
        //    for(var i = 0; i <=  clouds.length; i++){
        //         // for(var a = 0; a <= cloud.length; a++){
        //             console.log(cloud);
        //             if((clouds[i].toLowerCase()).indexOf(cloud) != -1){
        //                 document.getElementById("upload").disable = false;
        //                 document.getElementById("text").innerHTML = "";
        //             }
        //             else{
        //                 disable(cloud);
        //             }
        //         // }
        //     }
        // }
        
        // function disable(cloud){
        //     document.getElementById("upload").disable = true;
        //     document.getElementById("text").innerHTML = "Please check your " + cloud + " integration!";
        // }
        function sendJob(qid,file,clouds,formid,folder){
            var formdata = new FormData();
            var access = JFCustomWidget.getWidgetSetting("awsaccess");
            var secret = JFCustomWidget.getWidgetSetting("awssecret");
            var bucket = JFCustomWidget.getWidgetSetting("awsbucket");
            var region = JFCustomWidget.getWidgetSetting("awsregion");
            var key =JSON.stringify({access: access,secret: secret, bucket: bucket,region: region});
            console.log(key);
            formdata.append("qid",qid);
            formdata.append("file",file);
            formdata.append("clouds",clouds);
            formdata.append("formid",formid);
            formdata.append("folder",folder);
            formdata.append("action","upload");
            formdata.append("key",key);
            $.ajax({
                type: "POST",
                url: "database.php",
                enctype: "multipart/form-data",
                data: formdata,
                async: false,
                cache: false,
                contentType: false,
                processData: false,
                success: function(sccss){
                     urls = sccss;
                     do{
                     old = urls;
                     urls = urls.replace("\\","");
                     urls = urls.replace("{","");
                     urls = urls.replace("}","");
                     urls = urls.replace(",","<br>");
                     urls = urls.replace(" ","%20"); // space = %20
                     }
                     while (old != urls);
                    var result = {};
                    result.valid = true;
                    result.value = urls;
                    document.getElementById("uploaded").value == true;
                    JFCustomWidget.sendSubmit(result);
                    return urls;
                }
            })
        }
    </script>
    <script async defer src="https://apis.google.com/js/api.js">
    </script>
</body>
</html> 