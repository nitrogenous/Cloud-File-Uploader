<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <script src="jquery-3.2.1.min.js"></script>
    <link rel="stylesheet" href="index.css">
    <link href="https://fonts.googleapis.com/css?family=Roboto+Condensed" rel="stylesheet">
    <script src="//js.jotform.com/JotFormCustomWidget.min.js"></script>
    <script src="https://unpkg.com/dropbox/dist/Dropbox-sdk.min.js"></script>
    <script src="utils.js"></script>
    <title>XUP File Uploader</title>
</head>
<body>
    <form action="database.php" method="POST" enctype="multipart/form-data" id="xup" >
        <label for="upload" id="add" class="addFile">Add a File</label>
        <input type="file" name="upload[]" id="upload" multiple>

        <div id="hiddenInputs">
            <input type="hidden" id="aws">
            <input type="hidden" id="key">
            <input type="hidden" id="drive">
            <input type="hidden" id="folder">
            <input type="hidden" id="hidden">
            <input type="hidden" id="dropbox">
            <input type="hidden" id="uploaded">
            <input type="hidden" id="folderKey">
            <input type="hidden" id="url" value="false">
        </div>
        </form>
    <div id="text"></div>
    <script type="text/javascript">
        JFCustomWidget.subscribe("ready", function (formId) {
            $(document).ready(function(){
                console.log(JFCustomWidget.getWidgetSetting("clouds"));
                var filekey = generate_token(16);
                var formdata = new FormData();
                const form_id = formId["formID"];
                const qid = JFCustomWidget.getWidgetSetting("qid");
                const clouds = JFCustomWidget.getWidgetSetting("clouds");
                var status;
                formdata.append("formid", form_id);
                formdata.append("qid",qid);
                formdata.append("action", "check");
                document.getElementById("hidden").value = ajaxRequest("database.php",formdata,false);
                var status = JSON.parse(document.getElementById("hidden").value); 
                console.log(status);
                if((clouds.toLowerCase()).indexOf("dropbox") != -1){ 
                    if(!status.Dropbox){
                        document.getElementById("dropbox").value = false;
                        var client_id = "9pdfdpjr2pnqzmo";
                        var dbx = new Dropbox({clientId: client_id});
                        var authUrl = dbx.getAuthenticationUrl("https://toprak.jotform.pro/Adapter/oauth.html"); 
                        var AuthWindow = window.open(authUrl,"AuthWindow",'location=0,status=0,width=800,height=400');
                        $("#key").change(function(){
                            key = document.getElementById("key").value;
                            var formdata = new FormData();
                            formdata.append("key",key);
                            formdata.append("qid",qid);
                            formdata.append("action", "save");
                            formdata.append("value","dropbox");
                            formdata.append("formid", form_id);
                            document.getElementById("hidden").value = ajaxRequest("database.php",formdata,false);
                            AuthWindow.close();
                        }) 
                    }
                    else{
                        document.getElementById("dropbox").value = true;                        
                    } 
                }
                if((clouds.toLowerCase()).indexOf("drive") !=  -1){
                    if(status.Drive != true){
                        document.getElementById("drive").value = false;
                        this.onload=function(){};handleClientLoad();
                        var key = "AIzaSyAbodyJck6jBlV4oV9A3-E6xdMvf3JsdDg";
                        var client = "424058548993-sbd0hd1dflne6507emj91gad1pf9bebc.apps.googleusercontent.com";
                        var discovery = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
                        var scopes = "https://www.googleapis.com/auth/drive";
                        function handleClientLoad() {
                            gapi.load("client:auth2",initClient);
                        }
                        function initClient() {
                            gapi.client.init({
                                apiKey: key,
                                clientId: client,
                                discoveryDocs: discovery,
                                scope: scopes
                            }).then(function (){
                                gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);
                                updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
                                handleAuthClick();
                            });
                        }
                        function updateSigninStatus(isSignedIn) {
                            if (isSignedIn) {
                                console.log("signed");
                            }
                            addEventListener
                            {
                                console.log("error");
                            }
                        }
                        function handleAuthClick() {
                            console.log("handleAuthClick");
                            gapi.auth2.getAuthInstance().signIn();
                            gapi.auth2.getAuthInstance().grantOfflineAccess().then(function(code){
                                key = JSON.stringify(code);
                                var formdata = new FormData();
                                formdata.append("qid",qid);
                                formdata.append("value","drive");
                                formdata.append("key",key);
                                formdata.append("formid", form_id);
                                formdata.append("clouds", clouds);
                                formdata.append("action", "tokens");
                                $.ajax({
                                    type: "POST",
                                    url: "database.php",
                                    enctype: "multipart/form-data",
                                    data: formdata,
                                    async: false,
                                    cache: false,
                                    contentType: false,
                                    processData: false,
                                    success: function(sccss){
                                    }
                                });
                            })
                        }
                    }
                }
                if((clouds.toLowerCase()).indexOf("amazonwebservices") != -1){
                    if(empty(getAwsKeys())){
                        document.getElementById("upload").disable = true;
                        // document.getElementById("text").innerHTML = "<h3>Please check your AWS integration!</h3>";
                    }
                    else{
                        document.getElementById("text").innerHTML = "";
                    }
                }

                cloudsArray = clouds.split(",");
                cloudsArray.shift();
                cloudsArray.forEach(function(e){
                    if(!document.getElementById(e.toLowerCase()).value){
                        // document.getElementById("add").style.display = "none";
                        document.getElementById("text").innerHTML = "Please check your integrations";
                    }
                    else{
                        // document.getElementById("add").style.display = "inline-flex";
                        document.getElementById("text").innerHTML = "";   
                    }

                })
                $("#upload").change(function(e) {
                    e.preventDefault();
                    var input = document.getElementById("upload");  
                    for(var x = 0;x < input.files.length; x++){
                        var file = input.files[x];
                        upload(form_id,qid,file,filekey,x);
                    }
                    $("#url").change(function(){  
                        returnSubmit(JSON.stringify(document.getElementById("url").value),true);
                    })
                    // var folder = document.getElementById("folder").value;
                    // removeFiles(form_id,folder);                                   
                });

                JFCustomWidget.subscribe("submit",function(){
                    var folder = document.getElementById("folder").value;
                    if(document.getElementById("url").value != "false"){
                        removeFiles(form_id,folder);                                   
                        returnSubmit(JSON.stringify(document.getElementById("url").value),true);
                    }
                    else{
                        returnSubmit(null,false);
                    }
                })

            })  
        })
        function empty(input) {
            if(input == "" || input == 0 || input == "0" || input == null || input == false || input == undefined)  {
                return true;
            }
            else {
                return false;
            }
        }
        function upload(formid,qid,file,filekey,progressName){
            var folder = null;
            var formdata = new FormData();
            var id =  createDiv(generate_token(4),file.name,getFileExtension(file.name));
            formdata.append("qid",qid);
            formdata.append("file", file); 
            formdata.append("formid",formid);
            formdata.append("filekey",filekey);
            formdata.append("key",getAwsKeys());
            var progressBar = "progressBar-"+id;
            // var progressButton =;
            // console.log(progressBar);
            save(formdata,filekey,progressBar).done(function(result){
                if(empty(document.getElementById("folder").value)){
                    document.getElementById("folder").value = result; 
                    folder = JSON.parse(document.getElementById("folder").value);
                    document.getElementById("folder").value = folder["folder"];
                }
                let qid = JFCustomWidget.getWidgetSetting("qid");
                folder = document.getElementById("folder").value;
                var folderKey = document.getElementById("folderKey").value;
                var url = sendJob(qid,file.name,formid,folder+"-"+filekey,folderKey,""); //key,
                document.getElementById("url").value =  url;    
                progressDiv.querySelector("BUTTON").value = url;      
                $("#url").trigger("change");
            }).fail(function(){
                console.log("An Error Occured");
            });
            return true;
        }
        function save(formdata,filekey,progressId){
            return $.ajax({
                    type: "POST",
                    url: "save.php",
                    enctype: "multipart/form-data",
                    data: formdata,
                    cache: false,
                    // async: false,
                    contentType: false,
                    processData: false,
                    xhr: function () {
                        var xhr = $.ajaxSettings.xhr();
                        if (xhr.upload) {   
                            xhr.upload.addEventListener("progress", function (e) {
                                var percent = 0;
                                var position = e.loaded || e.position;
                                var total = e.total;
                                if (e.lengthComputable) {
                                    percent = Math.ceil(position / total * 100);
                                }
                                $("#"+progressId).attr("value", percent);
                            }, true);
                        }
                        return xhr;
                    },
                    success: function (sccss) {
                    }
                });
        }   
        function removeFiles(form_id,folder){
            ajaxRequest("removeFiles.php",{formid: form_id,folder: folder},false);
        }
        function ajaxRequest(url,formdata,async){
            var result = null;
            $.ajax({
                type: "POST",
                url: url,
                enctype: "multipart/form-data",
                data: formdata,
                async: async,
                cache: false,
                contentType: false,
                processData: false,
                success: function(sccss){
                    result = sccss;
                }
            })
            return result;
        }
        function sendJob(qid,file,formid,folder,folderKey,key){
            var formdata = new FormData();
            formdata.append("key",key);
            formdata.append("qid",qid);
            formdata.append("file",file);
            formdata.append("folder",folder);
            formdata.append("formid",formid);
            formdata.append("action","upload");
            formdata.append("folderKey",folderKey);
            var response = ajaxRequest("database.php",formdata,false);
            return response;
        }
        function getAwsKeys(){
            var access = JFCustomWidget.getWidgetSetting("awsaccess");
            var secret = JFCustomWidget.getWidgetSetting("awssecret");
            var bucket = JFCustomWidget.getWidgetSetting("awsbucket");
            var region = JFCustomWidget.getWidgetSetting("awsregion");
            var key =JSON.stringify({access: access,secret: secret, bucket: bucket,region: region});
            return key;
        }
        function urlReplace(url){
            do{
                old = url;
                url = url.replace("\\","");
                url = url.replace("{","");
                url = url.replace("}","");
                url = url.replace(",","<br>");
                url = url.replace(" ","%20"); //Space = %20
            }
            while(old != url);
            return url;
        }
        function generate_token(length){
            var a = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890".split("");
            var b = [];  
            for (var i=0; i<length; i++) {
                var j = (Math.random() * (a.length-1)).toFixed(0);
                b[i] = a[j];
            }
            return b.join("");
        }
        function returnSubmit(value,valid){
            var result = {};
            result.value = value;
            result.valid = valid;
            JFCustomWidget.sendSubmit(result);
        }
        function createDiv(id,file = null,fileExtension = null){
            var uploadItem = document.createElement("div");
            var imageSection = document.createElement("div");
            var img = document.createElement("img");
            var fileType = document.createElement("div");
            var progressSection = document.createElement("div");
            var progressFile = document.createElement("div");
            var progressBar = document.createElement("progress");
            var remove = document.createElement("button");
            
            uploadItem.classList.add("uploadItem");
            uploadItem.id = "uploadItem-"+id;
            imageSection.classList.add("imageSection");
            imageSection.id = "imageSection-"+id;
            img.setAttribute("src","https://i.hizliresim.com/p6qB80.png");
            img.setAttribute("alt","img");
            fileType.id = "fileType-"+id;
            progressSection.classList.add("progressSection");
            progressSection.id = "progressSection-"+id;
            progressFile.id = "progressFile-"+id;
            progressBar.id = "progressBar-"+id;
            remove.classList.add("remove");
            remove.id = "remove-"+id;

            fileType.appendChild(document.createTextNode(fileExtension.toUpperCase()));
            progressFile.appendChild(document.createTextNode(file));
            remove.appendChild(document.createTextNode("X"));

            document.getElementById("xup").appendChild(uploadItem);
            document.getElementById(uploadItem.id).appendChild(imageSection);
            document.getElementById(imageSection.id).appendChild(img);
            document.getElementById(imageSection.id).appendChild(fileType);
            document.getElementById(uploadItem.id).appendChild(progressSection);
            document.getElementById(progressSection.id).appendChild(progressFile);
            document.getElementById(progressSection.id).appendChild(progressBar);
            document.getElementById(uploadItem.id).appendChild(remove);

            return id;
        }
        function newLabelValue(id,newValue){
            document.getElementById(id).innerHTML = newValue;
            return true;
        }
        function getFileExtension(filename){
            return filename.split('.').pop();
        }
    </script>
    <script async defer src="https://apis.google.com/js/api.js">
    </script>
</body>
</html> 