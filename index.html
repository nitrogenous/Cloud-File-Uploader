<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy">
    <script src="jquery-3.2.1.min.js"></script>
    <link rel="stylesheet" href="index.css">
    <!-- <link href="https://fonts.googleapis.com/css?family=Roboto+Condensed" rel="stylesheet"> -->
    <script src="//js.jotform.com/JotFormCustomWidget.min.js"></script>
    <script src="https://unpkg.com/dropbox/dist/Dropbox-sdk.min.js"></script>
    <script src="utils.js"></script>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-112392850-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-112392850-1');
    </script>
    <title>XUP File Uploader</title>
</head>
<body>
    <form action="database.php" method="POST" enctype="multipart/form-data" id="xup" >
        <label for="upload" id="add" class="addFile">Add a File</label>
        <input type="file" name="upload[]" id="upload" multiple>

        <div id="hiddenInputs">
            <input type="hidden" id="aws">
            <input type="hidden" id="key">
            <input type="hidden" id="drive">
            <input type="hidden" id="folder">
            <input type="hidden" id="hidden">
            <input type="hidden" id="dropbox">
            <input type="hidden" id="uploaded">
            <input type="hidden" id="folderKey">
            <input type="hidden" id="url" value="">
        </div>
        </form>
    <div id="text"></div>
    <script type="text/javascript">
        $(document).ready(function(){
            JFCustomWidget.subscribe("ready", function (formId) {
                var size ={}; 
                size.width = 500; 
                size.height = 100; 
                JFCustomWidget.requestFrameResize(size); 
                var filekey = generate_token(16);
                var formdata = new FormData();
                const form_id = formId["formID"];
                const qid = JFCustomWidget.getWidgetSetting("qid");
                const clouds = JFCustomWidget.getWidgetSetting("clouds");
                console.log(JFCustomWidget.getWidgetSetting("clouds"));
                var status;
                formdata.append("formid", form_id);
                formdata.append("qid",qid);
                formdata.append("action", "check");
                document.getElementById("hidden").value = ajaxRequest("check.php",formdata,false);
                var status = JSON.parse(document.getElementById("hidden").value); 
                console.log(status);
                console.log(clouds);
                if((clouds.toLowerCase()).indexOf("dropbox") != -1){ 
                    if(!status.Dropbox){
                        document.getElementById("dropbox").value = false;
                        var client_id = "9pdfdpjr2pnqzmo";
                        var dbx = new Dropbox({clientId: client_id});
                        var authUrl = dbx.getAuthenticationUrl("https://toprak.jotform.pro/Adapter/oauth.html"); 
                        var AuthWindow = window.open(authUrl,"AuthWindow",'location=0,status=0,width=800,height=400');
                        $("#key").change(function(){
                            key = document.getElementById("key").value;
                            var formdata = new FormData();
                            formdata.append("key",key);
                            formdata.append("qid",qid);
                            formdata.append("action", "save");
                            formdata.append("value","dropbox");
                            formdata.append("formid", form_id);
                            jQuery.ajax({
                                    type: "POST",
                                    url: "database.php",
                                    enctype: "multipart/form-data",
                                    data: formdata,
                                    async: false,
                                    cache: false,
                                    contentType: false,
                                    processData: false,
                                    success: function(sccss){
                                    }
                                });
                            AuthWindow.close();
                        }) 
                    }
                    else{
                        document.getElementById("dropbox").value = true;                        
                    } 
                }
                if((clouds.toLowerCase()).indexOf("drive") !=  -1){
                    if(status.Drive != true){
                        document.getElementById("drive").value = false;
                        this.onload=function(){};handleClientLoad();
                        var key = "AIzaSyAbodyJck6jBlV4oV9A3-E6xdMvf3JsdDg";
                        var client = "424058548993-sbd0hd1dflne6507emj91gad1pf9bebc.apps.googleusercontent.com";
                        var discovery = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
                        var scopes = "https://www.googleapis.com/auth/drive";
                        function handleClientLoad() {
                            gapi.load("client:auth2",initClient);
                        }
                        function initClient() {
                            gapi.client.init({
                                apiKey: key,
                                clientId: client,
                                discoveryDocs: discovery,
                                scope: scopes
                            }).then(function (){
                                gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);
                                updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
                                handleAuthClick();
                            });
                        }
                        function updateSigninStatus(isSignedIn) {
                            if (isSignedIn) {
                                // console.log("signed");
                            }
                            addEventListener
                            {
                                // console.log("error");
                            }
                        }
                        function handleAuthClick() {
                            // console.log("handleAuthClick");
                            gapi.auth2.getAuthInstance().signIn();
                            gapi.auth2.getAuthInstance().grantOfflineAccess().then(function(code){
                                key = JSON.stringify(code);
                                var formdata = new FormData();
                                formdata.append("qid",qid);
                                formdata.append("value","drive");
                                formdata.append("key",key);
                                formdata.append("formid", form_id);
                                formdata.append("clouds", clouds);
                                formdata.append("action", "tokens");
                                jQuery.ajax({
                                    type: "POST",
                                    url: "database.php",
                                    enctype: "multipart/form-data",
                                    data: formdata,
                                    async: false,
                                    cache: false,
                                    contentType: false,
                                    processData: false,
                                    success: function(sccss){
                                    }
                                });
                            })
                        }
                    }
                }

                cloudsArray = clouds.split(",");
                cloudsArray.shift();
                cloudsArray.forEach(function(e){
                    if((clouds.toLowerCase()).indexOf("amazonwebservices") != -1){
                        if(empty(getAwsKeys())){
                            document.getElementById("upload").disable = true;
                            // document.getElementById("text").innerHTML = "<h3>Please check your AWS integration!</h3>";
                            document.getElementById("aws").value = getAwsKeys();
                        }
                        else{
                            document.getElementById("text").innerHTML = "";
                            document.getElementById("aws").value = null;
                        }
                    }
                    // if(!document.getElementById(e.toLowerCase()).value){
                    //     // document.getElementById("add").style.display = "none";
                    //     document.getElementById("text").innerHTML = "Please check your integrations";
                    // }
                    // else{
                    //     // document.getElementById("add").style.display = "inline-flex";
                    //     document.getElementById("text").innerHTML = "";   
                    // }
                })
                $("#upload").change(function(e) {
                    e.preventDefault();
                    var input = document.getElementById("upload");  
                    var currentHeight = window.innerHeight;
                    var totalItemHeights = (input.files.length) * 90;
                    var height = currentHeight + totalItemHeights;
                    setFrameSize(height);

                    for(var x = 0;x < input.files.length; x++){
                        var file = input.files[x];
                        upload(form_id,qid,file,filekey,x);

                    }
                   $("#url").change(function(e){
                        returnSubmit(JSON.stringify(document.getElementById("url").value),true);
                   })
                    // var folder = document.getElementById("folder").value;
                    // removeFiles(form_id,folder);                                   
                });

                JFCustomWidget.subscribe("submit",function(){
                    var children = document.getElementById("xup").children;
                    console.log(children);
                    console.log(children.length);

                    for(let i = 0; i <= children.length - 1;  i++){
                        if(children[i].id.indexOf("uploadItem") == -1){
                            if(i == (children.length-1)){
                                console.log(children[i].id);
                                document.getElementById("url").value = null;
                                returnSubmit(null,false);
                            }
                        }
                    }
                    var folder = document.getElementById("folder").value;
                    if(!empty(document.getElementById("url").value)){
                        // removeFiles(form_id,folder);                                   
                        returnSubmit(JSON.stringify(document.getElementById("url").value),true);
                    }
                    else{
                        returnSubmit(null,false);
                    }
                })
                function empty(input) {
                    if(input == "" || input == 0 || input == "0" || input == null || input == false || input == undefined)  {
                        return true;
                    }
                    else {
                        return false;
                    }
                }
                function upload(formid,qid,file,filekey,progressName){
                    var folder = null;
                    var formdata = new FormData();
                    var id =  createDiv(generate_token(4),file.name,getFileExtension(file.name));
                    formdata.append("qid",qid);
                    formdata.append("file", file); 
                    formdata.append("formid",formid);
                    formdata.append("filekey",filekey);
                    formdata.append("key",document.getElementById("aws").value);
                    var progressBar = "progressBar-"+id;
                    save(formdata,filekey,progressBar).done(function(result){
                        if(empty(document.getElementById("folder").value)){
                            document.getElementById("folder").value = result; 
                            folder = JSON.parse(document.getElementById("folder").value);
                            document.getElementById("folder").value = folder["folder"];
                        }
                        let qid = JFCustomWidget.getWidgetSetting("qid");
                        folder = document.getElementById("folder").value;
                        var callback = null;
                        var folderKey = document.getElementById("folderKey").value;
                        callBack = JSON.parse(sendJob(qid,file.name,formid,folder,folderKey,getAwsKeys())); //key,
                        // debugger;
                        if(empty(document.getElementById('folderKey').value)){
                            let folderId = JSON.parse(callBack.Drive);
                            folderId = folderId.Folder;
                            document.getElementById("folderKey").value = folderId;
                        }
                        console.log(callBack);
                        dropbox = JSON.parse(callBack.Dropbox);
                        dropboxUrl = dropbox.Url;
                        dropboxRemove = dropbox.Remove;
                        console.log(dropboxUrl +"\n"+dropboxRemove);
                        drive = JSON.parse(callBack.Drive);
                        driveUrl = drive.Url;
                        driveRemove = drive.Remove;
                        console.log(driveUrl +"\n"+driveRemove);
                        amazon = JSON.parse(callBack.AmazonWebServices);
                        amazonUrl = amazon.Url;
                        amazonRemove = amazon.Remove;
                        console.log(amazonUrl +"\n"+amazonRemove);

                        document.getElementById("url").value = "Dropbox:" + dropboxUrl +"<br>Drive:" + driveUrl + "<br>Amazon Web Services:" + amazonUrl;
                        var remove = JSON.parse(JSON.stringify({"Dropbox": dropboxRemove,"Drive": driveRemove,"Amazon": amazonRemove})); 
                        document.getElementById("remove-"+id).value = JSON.stringify({"formid": formid,"qid": qid,"Remove":remove});  
                        $("#url").trigger("change");
                    }).fail(function(){
                        console.log("An Error Occured");
                    });
                    return true;
                }
                function save(formdata,filekey,progressId){
                    return jQuery.ajax({
                            type: "POST",
                            url: "save.php",
                            enctype: "multipart/form-data",
                            data: formdata,
                            cache: false,
                            // async: false,
                            contentType: false,
                            processData: false,
                            xhr: function () {
                                var xhr = $.ajaxSettings.xhr();
                                if (xhr.upload) {   
                                    xhr.upload.addEventListener("progress", function (e) {
                                        var percent = 0;
                                        var position = e.loaded || e.position;
                                        var total = e.total;
                                        if (e.lengthComputable) {
                                            percent = Math.ceil(position / total * 100);
                                        }
                                        $("#"+progressId).attr("value", percent);
                                    }, true);
                                }
                                return xhr;
                            },
                            success: function (sccss) {
                            }
                        });
                }   
                function ajaxRequest(url,formdata,async){
                    var result = null;
                    jQuery.ajax({
                        type: "POST",
                        url: url,
                        enctype: "multipart/form-data",
                        data: formdata,
                        async: async,
                        cache: false,
                        contentType: false,
                        processData: false,
                        success: function(sccss){
                            result = sccss;
                        }
                    })
                    return result;
                }
                function sendJob(qid,file,formid,folder,folderKey,key){
                    var formdata = new FormData();
                    formdata.append("key",key);
                    formdata.append("qid",qid);
                    formdata.append("file",file);
                    formdata.append("folder",folder);
                    formdata.append("formid",formid);
                    formdata.append("action","upload");
                    formdata.append("folderKey",folderKey);
                    var response = ajaxRequest("database.php",formdata,false);
                    return response;
                }
                function getAwsKeys(){
                    var access = JFCustomWidget.getWidgetSetting("awsaccess");
                    var secret = JFCustomWidget.getWidgetSetting("awssecret");
                    var bucket = JFCustomWidget.getWidgetSetting("awsbucket");
                    var region = JFCustomWidget.getWidgetSetting("awsregion");
                    var key =JSON.stringify({access: access,secret: secret, bucket: bucket,region: region});
                    return key;
                }
                function urlReplace(url){
                    do{
                        old = url;
                        url = url.replace("\\","");
                        url = url.replace("{","");
                        url = url.replace("}","");
                        url = url.replace(",","<br>");
                        url = url.replace(" ","%20"); //Space = %20
                    }
                    while(old != url);
                    return url;
                }
                function generate_token(length){
                    var a = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890".split("");
                    var b = [];  
                    for (var i=0; i<length; i++) {
                        var j = (Math.random() * (a.length-1)).toFixed(0);
                        b[i] = a[j];
                    }
                    return b.join("");
                }
                function returnSubmit(value,valid){
                    var result = {};
                    result.value = value;
                    result.valid = valid;
                    JFCustomWidget.sendSubmit(result);
                }
                function createDiv(id,file = null,fileExtension = null){

                    var uploadItem = document.createElement("div");
                    var imageSection = document.createElement("div");
                    var img = document.createElement("img");
                    var fileType = document.createElement("div");
                    var progressSection = document.createElement("div");
                    var progressFile = document.createElement("div");
                    var progressBar = document.createElement("progress");
                    var remove = document.createElement("button");
                    // var removeImage = document.createElement("img");

                    uploadItem.id = "uploadItem-"+id;
                    uploadItem.classList.add("uploadItem");
                    imageSection.id = "imageSection-"+id;
                    imageSection.classList.add("imageSection");
                    img.setAttribute("alt","img");
                    img.setAttribute("src","https://i.hizliresim.com/dOzJkZ.png");
                    fileType.id = "fileType-"+id;
                    fileType.innerHTML = fileExtension.toUpperCase();
                    progressSection.id = "progressSection-"+id;
                    progressSection.classList.add("progressSection");
                    progressFile.id = "progressFile-"+id;
                    progressFile.innerHTML = file;
                    progressBar.id = "progressBar-"+id;
                    remove.classList.add("remove");
                    remove.id = "remove-"+id;
                    remove.innerHTML = '✕';
                    // removeImage.setAttribute("alt","remove-img");
                    // removeImage.setAttribute("src","https://i.hizliresim.com/Pl4V09.png");

                    var measurement = document.createElement("span");
                    document.getElementById("xup").appendChild(measurement);
                    measurement.id = "measurement-"+id;
                    measurement.classList.add("measurement");
                    document.getElementById(measurement.id).innerHTML = file;
                    if(document.getElementById(measurement.id).offsetWidth > 200){
                        progressFile.classList.add("progressFile-Long");
                        var indentValue = document.getElementById(measurement.id).offsetWidth-190;
                        var css = '#progressFile-'+id+':hover{ text-indent:-'+indentValue+'px; }';
                        head = document.head || document.getElementsByTagName('head')[0],
                        style = document.createElement('style');
                        style.type = 'text/css';
                        if (style.styleSheet){
                          style.styleSheet.cssText = css;
                        } else {
                          style.appendChild(document.createTextNode(css));
                        }

                        head.appendChild(style);
                    }
                    measurement.remove();
                    document.getElementById("xup").appendChild(uploadItem);
                    document.getElementById(uploadItem.id).appendChild(imageSection);
                    document.getElementById(imageSection.id).appendChild(img);
                    document.getElementById(imageSection.id).appendChild(fileType);
                    document.getElementById(uploadItem.id).appendChild(progressSection);
                    document.getElementById(progressSection.id).appendChild(progressFile);
                    document.getElementById(progressSection.id).appendChild(progressBar);
                    document.getElementById(uploadItem.id).appendChild(remove);
                    // document.getElementById(remove.id).appendChild(removeImage);
                   $("#"+remove.id).click(function(e){
                        e.preventDefault();
                        var params = JSON.parse(document.getElementById(remove.id).value);
                        var path = params.Remove;
                        path = JSON.stringify(path);
                        console.log(path);
                        var formdata = new FormData();
                        formdata.append("action","remove");
                        formdata.append("formid", params.formid);
                        formdata.append("qid", params.qid);
                        formdata.append("remove", path);
                        formdata.append("aws",getAwsKeys());
                        ajaxRequest("database.php",formdata,true);
                        var elements = document.getElementById("xup").children;
                        var totalItemHeights = (elements.length - 1) - 80;
                        if(totalItemHeights <= 500){
                            var height = totalItemHeights;
                            setFrameSize(height);
                        }
                        $("#"+uploadItem.id).remove();
                   })
                    return id;
                }
                function getFileExtension(filename){
                    return filename.split('.').pop();
                }
                function setFrameSize(height){
                    if(height < 530){
                        var size ={}; 
                        size.width = 500; 
                        size.height =  height; 
                        JFCustomWidget.requestFrameResize(size); 
                    }
                    else{
                        var size ={}; 
                        size.width = 500; 
                        size.height =  530; 
                        JFCustomWidget.requestFrameResize(size);
                    }
                    return true;
                }
            })  
        })
    </script>
    <script async defer src="https://apis.google.com/js/api.js">
    </script>
</body>
</html> 