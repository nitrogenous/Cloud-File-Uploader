<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <script src="jquery-3.2.1.min.js"></script>
    <script src="//js.jotform.com/JotFormCustomWidget.min.js"></script>
    <script src="https://unpkg.com/dropbox/dist/Dropbox-sdk.min.js"></script>
    <script src="utils.js"></script>
    <title>XUP File Uploader</title>
</head>
<body>
    <center>
    <form action="database.php" method="POST" enctype="multipart/form-data" id="xup" >
        <input type="file" name="upload" id="upload" >
        <input type="hidden" id="hidden" value="">
        <progress value="0" max="100" id="progressbar"></progress>
        <input type="hidden" name="key" id="key" value="" >
        <input type="hidden" id="formid">
        <input type="hidden" id="folder">
    </form>
    <div id="qid"> </div>
    <div id="text"><h3>Please check your integrations!</h3></div>
    </center>
    <script type="text/javascript">
        document.getElementById("upload").disabled = true;
        JFCustomWidget.subscribe("ready", function (formId) {
            $(document).ready(function(){
                // this.onload=function(){};handleClientLoad();
                var status;
                var formdata = new FormData();
                var qid = JFCustomWidget.getWidgetSetting("qid");
                var clouds = JFCustomWidget.getWidgetSetting("clouds");
                var form_id = formId["formID"];
                document.getElementById("formid").value = form_id;
                // console.log(document.getElementById("formid").value);
                formdata.append("formid", form_id);
                formdata.append("clouds", clouds); 
                formdata.append("qid",qid);
                formdata.append("action", "check");
                $.ajax({
                    type: "POST",
                    url: "database.php",
                    enctype: "multipart/form-data",
                    data: formdata,
                    async: false,
                    cache: false,
                    contentType: false,
                    processData: false,
                    success: function (sccss) {
                        console.log(sccss);
                        document.getElementById("hidden").value = sccss;
                    }
                });
                var status = JSON.parse(document.getElementById("hidden").value); 
                console.log(status);
                if((clouds.toLowerCase()).indexOf("dropbox") != -1)
                { 
                    if(status.Dropbox != true)
                    {
                        console.log("321");
                        var client_id = "9pdfdpjr2pnqzmo";
                        var dbx = new Dropbox({clientId: client_id});
                        var authUrl = dbx.getAuthenticationUrl("https://toprak.jotform.pro/Adapter/oauth.html"); 
                        var AuthWindow = window.open(authUrl,"AuthWindow",'location=0,status=0,width=800,height=400');
                        $("#key").change(function(){
                            key = document.getElementById("key").value;
                            var formdata = new FormData();
                            var form_id = formId["formID"];
                            formdata.append("action", "save");
                            formdata.append("qid",qid);
                            formdata.append("value","dropbox");
                            formdata.append("key",key);
                            formdata.append("formid", form_id);
                            formdata.append("clouds", clouds);
                            $.ajax({
                                type: "POST",
                                url: "database.php",
                                enctype: "multipart/form-data",
                                data: formdata,
                                async: false,
                                cache: false,
                                contentType: false,
                                processData: false,
                                success: function (sccss) {
                                    console.log(sccss);
                                    document.getElementById("hidden").value = sccss;
                                }
                            });
                            AuthWindow.close();
                            enable(clouds,status.value);
                        }) 
                    }
                }
                if((clouds.toLowerCase()).indexOf("drive") !=  -1)
                {
                    if(status.Drive != true)
                    {
                        this.onload=function(){};handleClientLoad();
                        var key = "AIzaSyAbodyJck6jBlV4oV9A3-E6xdMvf3JsdDg";
                        var client = "424058548993-sbd0hd1dflne6507emj91gad1pf9bebc.apps.googleusercontent.com";
                        var discovery = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
                        var scopes = "https://www.googleapis.com/auth/drive";

                        function handleClientLoad() {
                            gapi.load("client:auth2",initClient);
                        }

                        function initClient() {
                            gapi.client.init({
                                apiKey: key,
                                clientId: client,
                                discoveryDocs: discovery,
                                scope: scopes
                            }).then(function (){
                                gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);
                                updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
                                handleAuthClick();
                            });

                        }
                        function updateSigninStatus(isSignedIn) {
                            if (isSignedIn) {
                                console.log("signed");
                            }
                            else
                            {
                                console.log("error");
                            }
                        }
                        function handleAuthClick() {
                            console.log("handleAuthClick");
                            gapi.auth2.getAuthInstance().signIn();
                            gapi.auth2.getAuthInstance().grantOfflineAccess().then(function(code){
                                key = JSON.stringify(code);
                                var formdata = new FormData();
                                var form_id = formId["formID"];
                                formdata.append("qid",qid);
                                formdata.append("value","drive");
                                formdata.append("key",key);
                                formdata.append("formid", form_id);
                                formdata.append("clouds", clouds);
                                formdata.append("action", "tokens");
                                $.ajax({
                                    type: "POST",
                                    url: "database.php",
                                    enctype: "multipart/form-data",
                                    data: formdata,
                                    async: false,
                                    cache: false,
                                    contentType: false,
                                    processData: false,
                                    success: function(sccss){
                                        console.log(sccss);
                                    }
                                });
                            })
                        }    
                    }
                }
                enable(clouds,status.value) 
                $("#upload").change(function (e) {
                    e.preventDefault();
                    var formdata = new FormData();
                    var file = document.getElementById("upload").files[0];
                    var access_token = document.getElementById("accesskey");
                    formdata.append("qid",qid);
                    formdata.append("file", file);
                    // formdata.append("clouds", clouds);
                    formdata.append("formid",form_id);
                    // formdata.append("accesstoken",access_token);
                    $.ajax({
                        type: "POST",
                        url: "save.php",
                        enctype: "multipart/form-data",
                        data: formdata,
                        cache: false,
                        // async: false,
                        contentType: false,
                        processData: false,
                        xhr: function () {
                            var xhr = $.ajaxSettings.xhr();
                            if (xhr.upload) {   
                                xhr.upload.addEventListener("progress", function (e) {
                                    var percent = 0;
                                    var position = e.loaded || e.position;
                                    var total = e.total;
                                    if (e.lengthComputable) {
                                        percent = Math.ceil(position / total * 100);
                                    }
                                    $("#progressbar").attr("value", percent);
                                }, true);
                            }
                            return xhr;
                        },
                        success: function (sccss) {     
                            console.log(sccss);
                            document.getElementById("folder").value = sccss; 
                            var folder = JSON.parse(document.getElementById("folder").value);
                            document.getElementById("folder").value = folder["folder"];
                            console.log(document.getElementById("folder").value);
                        }
                    });
                    
                });
                })  
        })
        JFCustomWidget.subscribe("submit", function (formId) {
            var result = {};
            result.valid = true;
            // result.value = file;
            var formdata = new FormData();
            var form_id = document.getElementById("formid").value;
            console.log(form_id);
            var folder = document.getElementById("folder").value;
            var qid =  JFCustomWidget.getWidgetSetting("qid");
            var clouds = JFCustomWidget.getWidgetSetting("clouds");
            var file = document.getElementById('upload').value.split(/(\\|\/)/g).pop();
            formdata.append("qid", qid);
            formdata.append("file",file);
            formdata.append("clouds", clouds);
            formdata.append("formid", form_id);
            formdata.append("folder",folder);
            formdata.append("action","upload");
            $.ajax({
               type: "POST",
                url: "database.php",
                enctype: "multipart/form-data",
                data: formdata,
                async: false,
                cache: false,
                contentType: false,
                processData: false,
                success: function (sccss) {
                    console.log(sccss);
                    result.value = sccss;
                    JFCustomWidget.sendSubmit(result );
                }
            })
        });
        function empty(input)
        {
            if(input == "" || input == 0 || input == "0" || input == null || input == false || input == undefined)
            {
                return false;
            }
            else
            {
                return true;
            }
        }
        function enable(cloud,status){
            if((((cloud.toLowerCase()).indexOf("dropbox") != -1) || ((cloud.toLowerCase()).indexOf("drive") != -1)) && status != false)
            {
                document.getElementById("upload").disabled = false;
                document.getElementById("text").innerHTML = "";
            }
        }
    </script>
    <script async defer src="https://apis.google.com/js/api.js"
        >
    </script>
</body>
</html> 